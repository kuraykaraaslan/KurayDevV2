import { NextResponse } from 'next/server';
import {
  rateLimitMiddleware,
  addRateLimitHeaders,
  //csrfMiddleware,
  //corsPreflightMiddleware,
  addCorsHeaders,
  addSecurityHeaders,
} from '@/middlewares';

/**
 * Main middleware - orchestrates all middleware handlers
 */
export async function middleware(request: NextRequest) {
  const pathname = new URL(request.url).pathname;

  // Only apply middleware to API routes
  if (!pathname.startsWith('/api')) {
    return NextResponse.next();
  }

  /* 1. CORS Preflight
  const corsResponse = corsPreflightMiddleware(request);
  if (corsResponse) return corsResponse;
  */

  // 2. Rate Limiting
  const rateLimitResponse = await rateLimitMiddleware(request);
  if (rateLimitResponse) return rateLimitResponse;

  /* 3. CSRF Validation
  const csrfResponse = csrfMiddleware(request);
  if (csrfResponse) return csrfResponse;
  */

  // 4. Build response with headers
  const response = NextResponse.next();

  // Add all headers
  await addRateLimitHeaders(request, response);
  addCorsHeaders(request, response);
  addSecurityHeaders(response);

  return response;
}

export const config = {
  matcher: ['/api/:path*'],
  runtime: 'nodejs',
};