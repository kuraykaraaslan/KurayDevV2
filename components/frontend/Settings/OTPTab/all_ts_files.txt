=== ./index.tsx ===
'use client';

import { useEffect, useState } from 'react';
import { OTPMethodEnum } from '@/types/UserSecurityTypes';
import { SafeUserSecurity, SafeUserSecurityDefault } from '@/types/UserSecurityTypes';
import axiosInstance from '@/libs/axios';

import OTPMethodCard from './partials/OTPMethodCard';
import OTPConfirmModal from './partials/OTPConfirmModal';
import TOTPSetupModal from './partials/TOTPSetupModal';
import { useOTP } from './hooks/useOTP';
import { useTOTP } from './hooks/useTOTP';

export default function OTPTab() {

  const [userSecurity, setUserSecurity] = useState<SafeUserSecurity>(SafeUserSecurityDefault);

  /* ============ FETCH USER SECURITY ============ */
  useEffect(() => {
    const fetchUserSecurity = async () => {
      try {
        const res = await axiosInstance.get('/api/auth/me/security');
        setUserSecurity(res.data.userSecurity);
      } catch (err) {
        console.error('Kullanıcı güvenliği alınamadı', err);
      }
    };

    fetchUserSecurity();
  }, []);

  const otp = useOTP(userSecurity, setUserSecurity);
  const totp = useTOTP(userSecurity, setUserSecurity);

  const handleCardClick = async (method: typeof OTPMethodEnum.Enum[keyof typeof OTPMethodEnum.Enum]) => {
    if (method === OTPMethodEnum.Enum.TOTP_APP) {
      const enabled = userSecurity.otpMethods.includes(method);
      if (!enabled) {
        await totp.openTotpSetup();
      } else {
        // Open disable modal to verify TOTP code
        totp.openTotpDisableModal();
      }
      return;
    }

    // Email/SMS flow
    otp.openModalForMethod(method);
  };

  return (
    <>
      <div className="bg-base-100 rounded-xl p-6 space-y-6">
        <h2 className="text-lg font-bold">İki Faktörlü Doğrulama</h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {Object.values(OTPMethodEnum.Enum).map(method => (
            <OTPMethodCard
              key={method}
              method={method}
              enabled={userSecurity.otpMethods.includes(method)}
              onClick={() => handleCardClick(method)}
            />
          ))}
        </div>
      </div>

      <OTPConfirmModal
        open={otp.modalOpen}
        otpSent={otp.otpSent}
        otpCode={otp.otpCode}
        sendingOtp={otp.sendingOtp}
        verifying={otp.verifying}
        otpInputRef={otp.otpInputRef as React.RefObject<HTMLInputElement>}
        onSendOtp={otp.sendOtp}
        onVerify={otp.verifyAndApply}
        onChangeCode={otp.setOtpCode}
        onClose={otp.closeOtpModal}
      />

      <TOTPSetupModal
        open={totp.totpModalOpen}
        otpauthUrl={totp.totpOtpauthUrl}
        code={totp.totpCode}
        loadingSetup={totp.totpLoadingSetup}
        verifying={totp.totpVerifying}
        backupCodes={totp.totpBackupCodes}
        onStartSetup={totp.startTotpSetup}
        onVerify={totp.verifyTotpEnable}
        onChangeCode={totp.setTotpCode}
        onClose={totp.closeTotpModal}
      />

      <OTPConfirmModal
        open={totp.totpDisableModalOpen}
        otpSent={true}
        otpCode={totp.totpDisableCode}
        sendingOtp={false}
        verifying={totp.totpVerifying}
        otpInputRef={undefined as any}
        onSendOtp={() => {}}
        onVerify={totp.disableTOTP}
        onChangeCode={totp.setTotpDisableCode}
        onClose={totp.closeTotpDisableModal}
      />
    </>
  );
}



=== ./hooks/useTOTP.ts ===
import { useState } from 'react';
import axiosInstance from '@/libs/axios';
import { toast } from 'react-toastify';
import { OTPMethodEnum } from '@/types/UserSecurityTypes';
import { SafeUserSecurity } from '@/types/UserSecurityTypes';

export function useTOTP(userSecurity: SafeUserSecurity, onUserSecurityUpdate: (updated: SafeUserSecurity) => void) {
  
  /* ============ STATE ============ */
  const [totpModalOpen, setTotpModalOpen] = useState(false);
  const [totpOtpauthUrl, setTotpOtpauthUrl] = useState<string | null>(null);
  const [totpCode, setTotpCode] = useState('');
  const [totpLoadingSetup, setTotpLoadingSetup] = useState(false);
  const [totpVerifying, setTotpVerifying] = useState(false);
  const [totpDisableModalOpen, setTotpDisableModalOpen] = useState(false);
  const [totpDisableCode, setTotpDisableCode] = useState('');
  const [totpBackupCodes, setTotpBackupCodes] = useState<string[]>([]);

  /* ============ TOTP HANDLERS ============ */
  const openTotpSetup = async () => {
    setTotpModalOpen(true);
    setTotpCode('');
    setTotpOtpauthUrl(null);
    await startTotpSetup();
  };

  const closeTotpModal = () => {
    setTotpModalOpen(false);
  };

  const openTotpDisableModal = () => {
    setTotpDisableModalOpen(true);
    setTotpDisableCode('');
  };

  const closeTotpDisableModal = () => {
    setTotpDisableModalOpen(false);
    setTotpDisableCode('');
  };

  const startTotpSetup = async () => {
    try {
      setTotpLoadingSetup(true);
      const res = await axiosInstance.post('/api/auth/totp/setup');
      setTotpOtpauthUrl(res.data.otpauthUrl);
    } catch (err: any) {
      console.error(err);
      toast.error(err?.response?.data?.message || 'TOTP kurulumu başlatılamadı');
      setTotpModalOpen(false);
    } finally {
      setTotpLoadingSetup(false);
    }
  };

  const verifyTotpEnable = async () => {
    if (!totpCode) return;

    try {
      setTotpVerifying(true);
      const verifyRes = await axiosInstance.post('/api/auth/totp/enable', { otpToken: totpCode });

      if (!verifyRes.data?.success) {
        toast.error('TOTP doğrulanamadı');
        return;
      }

      // Store backup codes for display
      if (verifyRes.data?.backupCodes) {
        setTotpBackupCodes(verifyRes.data.backupCodes);
      }

      const updated = {
        ...userSecurity,
        otpMethods: [...new Set([...userSecurity.otpMethods, OTPMethodEnum.Enum.TOTP_APP])],
      };

      onUserSecurityUpdate(updated);

      toast.success('TOTP etkinleştirildi');
      // Don't close modal yet - show backup codes
    } catch (err: any) {
      console.error(err);
      toast.error(err?.response?.data?.message || 'TOTP etkinleştirilemedi');
    } finally {
      setTotpVerifying(false);
    }
  };

  const disableTOTP = async () => {
    try {
      setTotpVerifying(true);

      await axiosInstance.post('/api/auth/totp/disable', { otpToken: totpDisableCode });

      const updated = {
        ...userSecurity,
        otpMethods: userSecurity.otpMethods.filter(m => m !== OTPMethodEnum.Enum.TOTP_APP),
      };

      onUserSecurityUpdate(updated);

      toast.success('TOTP devre dışı bırakıldı');
      closeTotpDisableModal();
    } catch (err: any) {
      console.error(err);
      toast.error(err?.response?.data?.message || 'TOTP devre dışı bırakılamadı');
    } finally {
      setTotpVerifying(false);
    }
  };

  return {
    // State
    totpModalOpen,
    totpOtpauthUrl,
    totpCode,
    totpLoadingSetup,
    totpVerifying,
    totpDisableModalOpen,
    totpDisableCode,
    totpBackupCodes,

    // Handlers
    openTotpSetup,
    closeTotpModal,
    startTotpSetup,
    verifyTotpEnable,
    disableTOTP,
    setTotpCode,
    openTotpDisableModal,
    closeTotpDisableModal,
    setTotpDisableCode,
  };
}


=== ./hooks/useOTP.ts ===
import { useRef, useState } from 'react';
import { OTPMethodEnum, OTPMethod, OTPAction } from '@/types/UserSecurityTypes';
import { SafeUserSecurity } from '@/types/UserSecurityTypes';
import axiosInstance from '@/libs/axios';
import { toast } from 'react-toastify';

export function useOTP(userSecurity: SafeUserSecurity, onUserSecurityUpdate: (updated: SafeUserSecurity) => void) {

  /* ============ STATE ============ */
  const [pendingMethod, setPendingMethod] = useState<OTPMethod | null>(null);
  const [pendingAction, setPendingAction] = useState<OTPAction | null>(null);

  const [modalOpen, setModalOpen] = useState(false);
  const [otpCode, setOtpCode] = useState('');
  const [otpSent, setOtpSent] = useState(false);
  const [sendingOtp, setSendingOtp] = useState(false);
  const [verifying, setVerifying] = useState(false);
  const otpInputRef = useRef<HTMLInputElement>(null);

  const openModalForMethod = (method: OTPMethod) => {
    const enabled = userSecurity.otpMethods.includes(method);
    setPendingMethod(method);
    setPendingAction(enabled ? 'disable' : 'enable');

    setOtpCode('');
    setOtpSent(false);
    setModalOpen(true);
  };

  const closeOtpModal = () => setModalOpen(false);

  const sendOtp = async () => {
    if (!pendingMethod || !pendingAction) return;
    if (pendingMethod === OTPMethodEnum.Enum.TOTP_APP) return;

    try {
      setSendingOtp(true);
      await axiosInstance.post('/api/auth/me/security/send', {
        method: pendingMethod,
        action: pendingAction
      });
      setOtpSent(true);
      toast.success('Doğrulama kodu gönderildi');
      setTimeout(() => otpInputRef.current?.focus(), 100);
    } catch {
      toast.error('OTP gönderilemedi');
    } finally {
      setSendingOtp(false);
    }
  };

  const verifyAndApply = async () => {
    if (!pendingMethod || !pendingAction) return;

    try {
      setVerifying(true);

      const verifyRes = await axiosInstance.post('/api/auth/me/security/verify', {
        otpToken: otpCode,
        method: pendingMethod,
        action: pendingAction
      });

      if (!verifyRes.data?.success) {
        toast.error('OTP doğrulanamadı');
        return;
      }

      const updated =
        pendingAction === 'enable'
          ? [...new Set([...userSecurity.otpMethods, pendingMethod])]
          : userSecurity.otpMethods.filter(m => m !== pendingMethod);

      onUserSecurityUpdate({ ...userSecurity, otpMethods: updated });

      toast.success('2FA ayarı güncellendi');
      closeOtpModal();
    } catch (err: any) {
      console.error(err);
      toast.error(err?.response?.data?.message || 'Doğrulama başarısız');
    } finally {
      setVerifying(false);
    }
  };

  /* ============ RETURN STATE & HANDLERS ============ */
  return {
    // Security data
    userSecurity,

    // Email/SMS OTP state
    modalOpen,
    otpCode,
    otpSent,
    sendingOtp,
    verifying,
    otpInputRef,

    // Handlers
    openModalForMethod,
    closeOtpModal,
    sendOtp,
    verifyAndApply,
    setOtpCode,
  };
}


=== ./partials/OTPConfirmModal.tsx ===
import HeadlessModal from '@/components/common/Modal';

type Props = {
  open: boolean;
  otpSent: boolean;
  otpCode: string;
  sendingOtp: boolean;
  verifying: boolean;
  otpInputRef: React.RefObject<HTMLInputElement>;
  onSendOtp: () => void;
  onVerify: () => void;
  onChangeCode: (v: string) => void;
  onClose: () => void;
};

export default function OTPConfirmModal(props: Props) {
  const {
    open,
    otpSent,
    otpCode,
    sendingOtp,
    verifying,
    otpInputRef,
    onSendOtp,
    onVerify,
    onChangeCode,
    onClose,
  } = props;

  return (
    <HeadlessModal
      open={open}
      onClose={onClose}
      title="Güvenlik Doğrulaması"
      size="sm"
      closeOnBackdrop={false}
      closeOnEsc={false}
    >
      <div className="space-y-4">
        {!otpSent && (
          <button
            onClick={onSendOtp}
            disabled={sendingOtp}
            className="btn btn-primary w-full"
          >
            {sendingOtp ? 'Kod Gönderiliyor…' : 'Doğrulama Kodu Gönder'}
          </button>
        )}

        {otpSent && (
          <>
            <input
              ref={otpInputRef}
              maxLength={6}
              value={otpCode}
              onChange={e => onChangeCode(e.target.value)}
              className="input input-bordered w-full text-center text-2xl tracking-widest font-mono"
              placeholder="123456"
            />

            <button
              onClick={onVerify}
              disabled={verifying || otpCode.length !== 6}
              className="btn btn-primary w-full"
            >
              {verifying ? 'Doğrulanıyor…' : 'Doğrula'}
            </button>
          </>
        )}
      </div>
    </HeadlessModal>
  );
}


=== ./partials/TOTPSetupModal.tsx ===
import HeadlessModal from '@/components/common/Modal';

type Props = {
  open: boolean;
  otpauthUrl?: string | null;
  code: string;
  loadingSetup: boolean;
  verifying: boolean;
  backupCodes?: string[];
  onStartSetup: () => void;
  onVerify: () => void;
  onChangeCode: (v: string) => void;
  onClose: () => void;
};

export default function TOTPSetupModal(props: Props) {
  const {
    open,
    otpauthUrl,
    code,
    loadingSetup,
    verifying,
    backupCodes = [],
    onStartSetup,
    onVerify,
    onChangeCode,
    onClose,
  } = props;

  return (
    <HeadlessModal
      open={open}
      onClose={onClose}
      title={backupCodes.length > 0 ? "Yedek Kodlar" : "TOTP Kurulumu"}
      size={backupCodes.length > 0 ? "md" : "sm"}
      closeOnBackdrop={false}
      closeOnEsc={false}
    >
      <div className="space-y-4">
        {backupCodes.length > 0 ? (
          // Show backup codes after successful verification
          <>
            <div className="alert alert-warning">
              <span>Bu kodları güvenli bir yere kaydedin. Authenticator'a erişiminizi kaybettiğinizde bu kodları kullanabilirsiniz.</span>
            </div>
            <div className="bg-base-200 p-4 rounded-lg space-y-2">
              {backupCodes.map((code, idx) => (
                <div
                  key={idx}
                  className="font-mono text-sm select-all p-2 bg-base-100 rounded flex justify-between items-center"
                >
                  <span>{code}</span>
                </div>
              ))}
            </div>
            <button
              onClick={onClose}
              className="btn btn-primary w-full"
            >
              Tamam
            </button>
          </>
        ) : (
          // Show QR code setup
          <>
            {!otpauthUrl && (
              <button
                onClick={onStartSetup}
                disabled={loadingSetup}
                className="btn btn-primary w-full"
              >
                {loadingSetup ? 'Hazırlanıyor…' : 'Kurulumu Başlat'}
              </button>
            )}

            {otpauthUrl && (
              <>
                <div className="flex flex-col items-center gap-3">
                  {otpauthUrl && (
                    <img
                      src={`https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(otpauthUrl)}`}
                      alt="Authenticator QR"
                      className="rounded border border-base-300"
                      width={180}
                      height={180}
                    />
                  )}
                  <p className="text-sm text-base-content/70 text-center">
                    Authenticator uygulamasıyla QR kodu tarayın veya aşağıdaki bağlantıyı elle ekleyin.
                  </p>
                  <div className="textarea textarea-bordered w-full text-xs break-all select-all">
                    {otpauthUrl}
                  </div>
                </div>

                <div className="divider my-2" />

                <input
                  maxLength={6}
                  value={code}
                  onChange={e => onChangeCode(e.target.value)}
                  className="input input-bordered w-full text-center text-2xl tracking-widest font-mono"
                  placeholder="123456"
                />

                <button
                  onClick={onVerify}
                  disabled={verifying || code.length !== 6}
                  className="btn btn-primary w-full"
                >
                  {verifying ? 'Doğrulanıyor…' : 'Etkinleştir'}
                </button>
              </>
            )}
          </>
        )}
      </div>
    </HeadlessModal>
  );
}


=== ./partials/OTPMethodCard.tsx ===
import { OTPMethod } from '@/types/UserSecurityTypes';

type Props = {
  method: OTPMethod;
  enabled: boolean;
  onClick: () => void;
};

export default function OTPMethodCard({ method, enabled, onClick }: Props) {
  return (
    <div
      onClick={onClick}
      className={`p-4 rounded-lg border cursor-pointer transition
        ${enabled
          ? 'border-primary bg-primary/10'
          : 'border-base-300 hover:bg-base-200'
        }
      `}
    >
      <div className="flex justify-between items-center">
        <span className="font-semibold">{method}</span>
        <span className={`text-sm ${enabled ? 'text-primary' : 'text-base-content/60'}`}>
          {enabled ? 'Aktif' : 'Kapalı'}
        </span>
      </div>
    </div>
  );
}


